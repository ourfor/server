#
# MDEV-12404 Test Index Condition Pushdown for Partitioned Tables
#

--source include/have_partition.inc
--source include/have_innodb.inc
--source include/have_sequence.inc

# Show that MyISAM is not supported
CREATE TABLE t1 (a int PRIMARY KEY, b BLOB, c varchar(16) DEFAULT 'Filler...',
INDEX (b(4), a)) ENGINE = MyISAM PARTITION BY HASH (a) PARTITIONS 3;

INSERT INTO t1 (a, b) VALUES (1, 0xdeadbeef), (2, "text filler"),
(3, 'filler...'), (4, " more filler "), (5, "test text"), (6, "testing...");

SELECT a, HEX(b) FROM t1 WHERE b >= 'te' and (a % 2);
select * from information_schema.session_status where variable_name like 'Handler_icp%';

# BLOBs allowed by InnoDB
CREATE TABLE t2 (a int PRIMARY KEY, b BLOB, c varchar(16) DEFAULT 'Filler...',
INDEX (b(4), a)) ENGINE = innodb PARTITION BY HASH (a) PARTITIONS 3;

INSERT INTO t2 (a, b) VALUES (1, 0xdeadbeef), (2, "text filler"),
(3, 'filler...'), (4, " more filler "), (5, "test text"), (6, "testing...");

set @tmp_optimizer_switch= @@optimizer_switch;
set @@optimizer_switch='index_condition_pushdown=off';
SELECT a, HEX(b) FROM t2 WHERE b >= 'te' and (a % 2);
select * from information_schema.session_status where variable_name like 'Handler_icp%';
set optimizer_switch=@tmp_optimizer_switch;
SELECT a, HEX(b) FROM t2 WHERE b >= 'te' and (a % 2);
select * from information_schema.session_status where variable_name like 'Handler_icp%';

# Ticket test case with innodb.
CREATE TABLE t3 (
   pk INT PRIMARY KEY,
   a INT,
   b INT,
   c INT,
   filler varchar(100),
   key(a,b,c)
 ) engine=innodb partition by hash(pk) partitions 4;

INSERT INTO t3 SELECT seq, seq, seq, seq, 'hello' FROM seq_1_to_10000;

set @tmp_optimizer_switch= @@optimizer_switch;
set @@optimizer_switch='index_condition_pushdown=off';
SELECT * from t3 where a < 10 AND (b+1>3);
select * from information_schema.session_status where variable_name like 'Handler_icp%';
set optimizer_switch=@tmp_optimizer_switch;
SELECT * from t3 where a < 10 AND (b+1>3);
select * from information_schema.session_status where variable_name like 'Handler_icp%';

# Ticket test case with myisam, which will reject index condition pushdown.
CREATE TABLE t4 (
   pk INT PRIMARY KEY,
   a INT,
   b INT,
   c INT,
   filler varchar(100),
   key(a,b,c)
 ) engine=myisam partition by hash(pk) partitions 4;

INSERT INTO t4 SELECT seq, seq, seq, seq, 'hello' FROM seq_1_to_10000;

set @tmp_optimizer_switch= @@optimizer_switch;
set @@optimizer_switch='index_condition_pushdown=off';
SELECT * from t4 where a < 10 AND (b+1>3);
select * from information_schema.session_status where variable_name like 'Handler_icp%';
set optimizer_switch=@tmp_optimizer_switch;
SELECT * from t4 where a < 10 AND (b+1>3);
select * from information_schema.session_status where variable_name like 'Handler_icp%';

drop table t1, t2, t3, t4;

--echo #
--echo # End of 11.4 tests
--echo #
